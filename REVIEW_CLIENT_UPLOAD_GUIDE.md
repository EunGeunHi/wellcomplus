# 리뷰 시스템 클라이언트 업로드 방식 구현 가이드

## 개요

리뷰 시스템을 기존의 서버 경유 업로드 방식에서 클라이언트 직접 업로드 방식으로 변경하여 모바일 환경에서의 안정성과 사용자 경험을 크게 개선했습니다.

## 주요 개선사항

### 1. 파일 크기 제한 확대

- **기존**: 4.5MB (Vercel 서버리스 함수 제한)
- **개선**: 10MB (개별 파일), 최대 5장

### 2. 모바일 안정성 향상

- 네트워크 불안정 시에도 안정적인 업로드
- 대용량 파일 업로드 시 타임아웃 방지
- 실시간 업로드 진행률 표시

### 3. 사용자 경험 개선

- 직관적인 진행률 표시
- 모바일 친화적인 UI/UX
- 업로드 중 상태 표시 및 안내

## 구현된 파일들

### 1. 클라이언트 업로드 유틸리티

- `lib/client-blob-upload-review.js`: 리뷰 이미지 클라이언트 업로드 함수들
- `app/api/reviews/upload-token/route.js`: 업로드 토큰 생성 API

### 2. API 수정

- `app/api/reviews/route.js`: 리뷰 등록 API (클라이언트 업로드 방식)
- `app/api/reviews/[id]/route.js`: 리뷰 수정 API (클라이언트 업로드 방식)

### 3. 프론트엔드 컴포넌트

- `app/components/ReviewUploadProgress.js`: 업로드 진행률 모달
- `app/components/ReviewEditModal.js`: 리뷰 수정 모달 (클라이언트 업로드 적용)
- `app/userpage/[id]/page.js`: 리뷰 작성 폼 (클라이언트 업로드 적용)

## 주요 기능

### 1. 파일 검증

```javascript
// 파일 타입 검증 (JPG, PNG만 허용)
// 파일 크기 검증 (개별 10MB 제한)
// 파일 개수 검증 (최대 5장)
```

### 2. 실시간 진행률 표시

```javascript
// 업로드 진행률 콜백
onProgress({
  current: 1,
  total: 3,
  fileName: 'image.jpg',
  status: 'uploading',
  percentage: 33,
});
```

### 3. 모바일 최적화

- 터치 친화적인 버튼 크기
- 명확한 상태 표시
- 업로드 중 화면 끄지 말라는 안내
- 파일 선택 UI 개선

## 사용 방법

### 1. 리뷰 작성

1. 서비스 유형 선택
2. 별점 선택 (1-5점)
3. 리뷰 내용 작성 (최소 10자)
4. 이미지 선택 (선택사항, 최대 5장)
5. 제출 버튼 클릭
6. 이미지 업로드 진행률 확인
7. 완료 후 자동으로 리뷰 목록 새로고침

### 2. 리뷰 수정

1. 기존 리뷰에서 수정 버튼 클릭
2. 내용 수정
3. 기존 이미지 삭제/새 이미지 추가
4. 저장 버튼 클릭
5. 업로드 진행률 확인
6. 완료 후 모달 닫기

## 기술적 세부사항

### 1. 업로드 플로우

```
1. 사용자가 파일 선택
2. 클라이언트에서 파일 검증
3. 업로드 토큰 요청 (/api/reviews/upload-token)
4. Vercel Blob Storage에 직접 업로드
5. 업로드된 파일 정보와 함께 리뷰 API 호출
6. MongoDB에 리뷰 데이터 저장
```

### 2. 파일명 규칙

```
reviews/{reviewId}/{timestamp}_{index}_{originalName}
예: reviews/temp123/1703123456789_0_image.jpg
```

### 3. 에러 처리

- 네트워크 오류 시 재시도 안내
- 파일 크기/타입 오류 시 명확한 메시지
- 업로드 실패 시 롤백 처리

## 환경 설정

### 필수 환경 변수

```env
BLOB_READ_WRITE_TOKEN=your_vercel_blob_token
```

### 패키지 의존성

```json
{
  "@vercel/blob": "^0.15.1"
}
```

## 모바일 최적화 특징

### 1. 터치 인터페이스

- 큰 터치 영역 (최소 44px)
- 명확한 시각적 피드백
- 스와이프 제스처 지원

### 2. 네트워크 최적화

- 청크 단위 업로드
- 재시도 메커니즘
- 진행률 실시간 표시

### 3. 배터리 최적화

- 업로드 중 화면 꺼짐 방지 안내
- 효율적인 메모리 사용
- 백그라운드 처리 최소화

## 테스트 시나리오

### 1. 기본 기능 테스트

- [ ] 리뷰 작성 (텍스트만)
- [ ] 리뷰 작성 (이미지 포함)
- [ ] 리뷰 수정
- [ ] 이미지 삭제/추가

### 2. 파일 검증 테스트

- [ ] 지원하지 않는 파일 타입 업로드
- [ ] 10MB 초과 파일 업로드
- [ ] 5장 초과 이미지 업로드

### 3. 모바일 테스트

- [ ] iOS Safari에서 업로드
- [ ] Android Chrome에서 업로드
- [ ] 네트워크 불안정 상황에서 업로드
- [ ] 대용량 파일 업로드

## 문제 해결

### 1. 업로드 실패 시

1. 네트워크 연결 확인
2. 파일 크기/타입 확인
3. 브라우저 새로고침 후 재시도

### 2. 진행률이 멈춘 경우

1. 잠시 대기 (네트워크 지연 가능)
2. 취소 후 재시도
3. 파일 크기 줄여서 재시도

### 3. 모바일에서 업로드 안 되는 경우

1. 브라우저 업데이트 확인
2. 저장 공간 확인
3. 다른 브라우저로 시도

## 향후 개선 계획

1. **이미지 압축**: 클라이언트에서 자동 이미지 압축
2. **오프라인 지원**: 네트워크 복구 시 자동 업로드
3. **드래그 앤 드롭**: 데스크톱에서 드래그 앤 드롭 지원
4. **미리보기 개선**: 이미지 확대/축소 기능

---

이제 모바일 사용자들도 안정적으로 대용량 이미지와 함께 리뷰를 작성할 수 있습니다! 🎉
